#!/usr/bin/env bash
set -Eeuo pipefail

# Generate skill-patterns.sh from SKILL.md frontmatter descriptions.
# Extracts "Use when" trigger text and assigns priority tiers.
# Output is a DRAFT — hand-tune the regex patterns after generation.
#
# Usage: bash scripts/generate-skill-hooks.sh

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
PLUGIN_DIR="$REPO_ROOT/plugins/compound-engineering"
SKILLS_DIR="$PLUGIN_DIR/skills"
OUTPUT="$PLUGIN_DIR/hooks/skill-patterns.sh"

# --- Tier assignments ---
# Update this map when adding new skills.
# 1 = Methodology (process/approach), 2 = Domain (language/framework), 3 = Supporting (workflow)

declare -A TIER_MAP=(
  # Tier 1: Methodology
  [planning]=1
  [debugging]=1
  [code-review]=1
  [simplifying-code]=1
  [brainstorming]=1
  # Tier 2: Domain/Language
  [php-laravel]=2
  [testing-laravel]=2
  [react-frontend]=2
  [testing-react]=2
  [nodejs-backend]=2
  [python-services]=2
  [postgresql]=2
  [terraform]=2
  [linux-bash-scripting]=2
  [pinescript]=2
  [frontend-design]=2
  [agent-native-architecture]=2
  # Tier 3: Supporting/Workflow
  [writing]=3
  [md-docs]=3
  [refine-prompt]=3
  [meta-prompting]=3
  [reflect]=3
  [compound-docs]=3
  [document-review]=3
  [file-todos]=3
  [orchestrating-swarms]=3
  [git-worktree]=3
  [resolve-pr-parallel]=3
  [setup]=3
)

# Ensure hooks directory exists
mkdir -p "$(dirname "$OUTPUT")"

# --- Header ---
{
  cat <<'HEADER'
#!/usr/bin/env bash
# AUTO-GENERATED by scripts/generate-skill-hooks.sh — do not edit manually
HEADER
  printf '# Generated: %s\n' "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
  printf '#\n# To regenerate from SKILL.md frontmatter:\n'
  printf '#   bash scripts/generate-skill-hooks.sh\n'
  printf '# Then hand-tune the regex patterns as needed.\n\n'
  printf 'declare -A SKILL_PATTERNS\n'
  printf 'declare -A SKILL_TIERS\n\n'
} > "$OUTPUT"

count=0
current_tier=0

for skill_dir in "$SKILLS_DIR"/*/; do
  [[ -d "$skill_dir" ]] || continue
  skill_name="$(basename "$skill_dir")"
  skill_file="$skill_dir/SKILL.md"

  [[ -f "$skill_file" ]] || continue

  # Extract YAML frontmatter (between first and second ---)
  frontmatter=$(awk '/^---$/{n++; next} n==1{print} n>=2{exit}' "$skill_file")

  # Extract description field (may span multiple lines)
  description=$(printf '%s\n' "$frontmatter" \
    | awk '
      /^description:/ { sub(/^description:[[:space:]]*/, ""); sub(/^>-[[:space:]]*/, ""); printing=1; print; next }
      printing && /^[a-z]+:/ { printing=0; next }
      printing { sub(/^[[:space:]]+/, ""); print }
    ' \
    | tr '\n' ' ' \
    | sed 's/[[:space:]]\+/ /g; s/[[:space:]]*$//')

  if [[ -z "$description" ]]; then
    printf "  WARN: no description for %s, skipping\n" "$skill_name" >&2
    continue
  fi

  # Extract "Use when" trigger text if present
  trigger_text=$(printf '%s' "$description" | sed -n 's/.*[Uu]se when[[:space:]]*//p')

  # Determine tier (default to 3)
  tier="${TIER_MAP[$skill_name]:-3}"

  # Add tier section header if tier changed
  if [[ "$tier" != "$current_tier" ]]; then
    case "$tier" in
      1) printf '\n# --- Tier 1: Methodology (process/approach skills) ---\n\n' >> "$OUTPUT" ;;
      2) printf '\n# --- Tier 2: Domain/Language (language/framework-specific) ---\n\n' >> "$OUTPUT" ;;
      3) printf '\n# --- Tier 3: Supporting/Workflow ---\n\n' >> "$OUTPUT" ;;
    esac
    current_tier="$tier"
  fi

  # Write pattern entry (raw trigger text — needs hand-tuning to regex)
  {
    printf "# Triggers: %s\n" "${trigger_text:-$description}"
    printf 'SKILL_PATTERNS[%s]=%q\n' "$skill_name" "${trigger_text:-$description}"
    printf 'SKILL_TIERS[%s]=%s\n\n' "$skill_name" "$tier"
  } >> "$OUTPUT"

  count=$((count + 1))
done

printf '\n# Total skills: %d\n' "$count" >> "$OUTPUT"

printf "Generated %d skill patterns to %s\n" "$count" "$OUTPUT"
printf "IMPORTANT: Hand-tune the regex patterns in %s before use.\n" "$OUTPUT"
